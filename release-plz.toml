# Configuration for release-plz
# See https://release-plz.dev/docs/config
# Since this is a workspace, both crates will be released together with the same version.

[workspace]
# IMPORTANT: Set to false to avoid race conditions with squash merges.
# Packages will only be released when you merge the release PR.
release_always = false

# Disable changelog updates for all workspace members
changelog_update = false

# This will detect breaking API changes and bump versions accordingly.
semver_check = true

# Automatically update dependencies between workspace members
dependencies_update = true

# Customize the release PR
pr_labels = ["release"]
pr_name = "feat: release {{ version }}"

# Disable release and tag creation for all workspace members
git_release_enable = false
git_tag_enable = false

# Only generate a changelog explicitly for prometric-derive,
# but include the changes from prometric.
[[package]]
name = "prometric-derive"
changelog_update = true
changelog_path = "./CHANGELOG.md"
changelog_include = ["prometric"]

# Configure the tag and release name for this main package.
git_tag_name = "v{{ version }}"
git_release_name = "v{{ version }}"
git_release_enable = true
git_tag_enable = true

[changelog]
# Configure changelog generation using conventional commits
commit_parsers = [
    # Only include commits with PR references (merge commits)
    # NOTE: This will only work if merge commits adopt the PR name (configured in repo settings).
    { message = "^feat", group = "Features" },
    { message = "^fix", group = "Bug Fixes" },
    { message = "^docs", group = "Documentation" },
    { message = "^perf", group = "Performance" },
    { message = "^refactor", group = "Refactor" },

    # Skip release commits
    { message = "^feat\\(release\\)", skip = true },

    # Skip everything else (individual commits without PR numbers)
    { message = ".*", skip = true },
]

body = """
  {% for group, commits in commits | group_by(attribute="group") -%}
  ### {{ group }}
  {% for commit in commits -%}
  {% if commit.remote.pr_number -%}
  - {{ commit.message }} by @{{ commit.remote.username }} in 
  https://github.com/chainbound/prometric/pull/{{ commit.remote.pr_number }}
  {% endif -%}
  {% endfor -%}
  {% endfor -%}
"""
