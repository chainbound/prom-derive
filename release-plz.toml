# Configuration for release-plz
# See https://release-plz.dev/docs/config
# Since this is a workspace, both crates will be released together with the same version.

[workspace]
# IMPORTANT: Set to false to avoid race conditions with squash merges.
# Packages will only be released when you merge the release PR.
release_always = false

# This will detect breaking API changes and bump versions accordingly.
semver_check = true

# Automatically update dependencies between workspace members
dependencies_update = true

# Customize the release PR
pr_labels = ["release"]
pr_name = "feat: release {{ version }}"

# Single unified release tag and name (instead of per-package)
# Default would be: prometric-v0.1.2, prometric-derive-v0.1.2
# This creates a single tag: v0.1.2
git_tag_name = "v{{ version }}"
git_release_name = "v{{ version }}"

[changelog]
# Configure changelog generation using conventional commits
commit_parsers = [
    { message = "^feat", group = "Features" },
    { message = "^fix", group = "Bug Fixes" },
    { message = "^docs", group = "Documentation" },
    { message = "^perf", group = "Performance" },
    { message = "^refactor", group = "Refactor" },
    { message = "^feat\\(release\\)", skip = true },
    { message = "^chore", skip = true },
]

# Strip conventional commit prefixes from messages in changelog
# This turns "feat: add feature" into "add feature"
commit_preprocessors = [
    { pattern = '^(feat|fix|docs|perf|refactor|test|chore|style|ci|build)(\(.+\))?: ', replace = "" },
]

# Custom body template to format commits as:
# - support histogram bucket configuration attribute by @mempirate in #11
body = """
{% for group, commits in commits | group_by(attribute="group") -%}
### {{ group }}
{% for commit in commits -%}
- {{ commit.message }}{% if commit.remote.username %} by @{{ commit.remote.username }}{% endif %}{% if commit.remote.pr_number %} in https://github.com/chainbound/prometric/pull/{{ commit.remote.pr_number }}{% endif %}
{% endfor -%}
{% endfor -%}
"""
